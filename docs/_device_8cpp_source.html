<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Disaggregate: /mnt/sshfs/imperialroot/homes/dk3810/workingcopies/disaggregate/src/Device.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Disaggregate</div>
   <div id="projectbrief">Disaggregate Smart Meter data</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_device_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Device.cpp</h1>  </div>
</div>
<div class="contents">
<a href="_device_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Device.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> *  Created on: 7 Jul 2011</span>
<a name="l00005"></a>00005 <span class="comment"> *      Author: jack</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="_device_8h.html">Device.h</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="_signature_8h.html">Signature.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="_common_8h.html">Common.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;cstdlib&gt;</span> <span class="comment">// abs</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;limits&gt;</span> <span class="comment">// std::numeric_limits&lt;std::size_t&gt;::max</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="keyword">using namespace </span>std;
<a name="l00018"></a>00018 
<a name="l00019"></a><a class="code" href="class_device.html#ae03e04f5c21169778c8b6ba1bd06ca47">00019</a> <a class="code" href="class_device.html#ae03e04f5c21169778c8b6ba1bd06ca47">Device::Device</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> _name) : name(_name) {
<a name="l00020"></a>00020     cout &lt;&lt; <span class="stringliteral">&quot;Creating Device object with name: &quot;</span> &lt;&lt; <a class="code" href="class_device.html#ae779f5ee618677629b71287f3f77f8e8">name</a> &lt;&lt; endl;
<a name="l00021"></a>00021     <a class="code" href="class_device.html#a86a4d85b59e1f2256239c7fd383ad231">powerStateGraph</a>.<a class="code" href="class_power_state_graph.html#ad077e00b7ecda2cdf2acb79201cbd6aa">setDeviceName</a>( <a class="code" href="class_device.html#ae779f5ee618677629b71287f3f77f8e8">name</a> );
<a name="l00022"></a>00022 }
<a name="l00023"></a>00023 
<a name="l00024"></a><a class="code" href="class_device.html#a9dabc419c8d8df3a686c33ce042bc99a">00024</a> <a class="code" href="class_device.html#a9dabc419c8d8df3a686c33ce042bc99a">Device::~Device</a>() {
<a name="l00025"></a>00025     <span class="keywordflow">for</span> (vector&lt;Signature*&gt;::iterator it=<a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.begin(); it!=<a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.end(); it++) {
<a name="l00026"></a>00026         <span class="keyword">delete</span> *it;
<a name="l00027"></a>00027     }
<a name="l00028"></a>00028 }
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="class_device.html#ad9f5d60c14401771afbf7dfb7e6e139d">00030</a> <span class="keyword">const</span> <span class="keywordtype">string</span> <a class="code" href="class_device.html#ad9f5d60c14401771afbf7dfb7e6e139d">Device::getName</a>()<span class="keyword"> const</span>
<a name="l00031"></a>00031 <span class="keyword"></span>{
<a name="l00032"></a>00032     <span class="keywordflow">return</span> <a class="code" href="class_device.html#ae779f5ee618677629b71287f3f77f8e8">name</a>;
<a name="l00033"></a>00033 }
<a name="l00034"></a>00034 
<a name="l00038"></a><a class="code" href="class_device.html#a82d7e65439c0191ab9e767612b2ed843">00038</a> <span class="keywordtype">void</span> <a class="code" href="class_device.html#a82d7e65439c0191ab9e767612b2ed843" title="Load signature data files.">Device::loadSignatures</a>(
<a name="l00039"></a>00039         <span class="keyword">const</span> vector&lt; string &gt;&amp; sigFiles, 
<a name="l00040"></a>00040         <span class="keyword">const</span> <span class="keywordtype">size_t</span> cropFront, 
<a name="l00041"></a>00041         <span class="keyword">const</span> <span class="keywordtype">size_t</span> cropBack   
<a name="l00042"></a>00042         )
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044     cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;**** LOADING DATA FILES... *****&quot;</span> &lt;&lt; endl &lt;&lt; endl;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046     vector&lt; string &gt;::const_iterator sigFile;
<a name="l00047"></a>00047     <span class="keywordflow">for</span> (sigFile = sigFiles.begin(); sigFile!=sigFiles.end(); sigFile++) {
<a name="l00048"></a>00048 
<a name="l00049"></a>00049         <span class="comment">// Check sig file exists</span>
<a name="l00050"></a>00050         <span class="keywordtype">string</span> fullSigFilename = <a class="code" href="_common_8h.html#a944976e0baf741f3849e9582368b60cc">SIG_DATA_PATH</a> + *sigFile;
<a name="l00051"></a>00051         <span class="keywordflow">if</span> ( ! <a class="code" href="namespace_utils.html#ae7741f30cf104d6660673d7c336ef5cc">Utils::fileExists</a>( fullSigFilename ) ) {
<a name="l00052"></a>00052             <a class="code" href="namespace_utils.html#a5f35365dae06a93f4bbf0f406a78b90b">Utils::fatalError</a>( <span class="stringliteral">&quot;Signature file &quot;</span> + fullSigFilename + <span class="stringliteral">&quot; does not exist.&quot;</span> );
<a name="l00053"></a>00053         }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055         <span class="comment">// Create a new signature</span>
<a name="l00056"></a>00056         <a class="code" href="class_signature.html" title="Class for storing a Device&amp;#39;s signature recorded by, for example, a Watts Up plug-in power logger...">Signature</a> * sig = <span class="keyword">new</span> <a class="code" href="class_signature.html" title="Class for storing a Device&amp;#39;s signature recorded by, for example, a Watts Up plug-in power logger...">Signature</a>
<a name="l00057"></a>00057                 (
<a name="l00058"></a>00058                 fullSigFilename,  <span class="comment">// filename</span>
<a name="l00059"></a>00059                 1,                <span class="comment">// sample period</span>
<a name="l00060"></a>00060                 sigFile-&gt;substr(0, sigFile-&gt;length()-4), <span class="comment">// sig filename without suffix</span>
<a name="l00061"></a>00061                 <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.size(),<span class="comment">// Provides the signature with its sigID.</span>
<a name="l00062"></a>00062                 cropFront, cropBack
<a name="l00063"></a>00063                 );
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.push_back( sig );
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00073"></a><a class="code" href="class_device.html#ad3d9721aca89723e22cf723149a39583">00073</a> <span class="keywordtype">void</span> <a class="code" href="class_device.html#ad3d9721aca89723e22cf723149a39583" title="Trains the powerStateGraph using signatures declared with loadSignatures(). To be called once signatu...">Device::trainPowerStateGraph</a>()
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075     cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;***** TRAINING POWER STATE GRAPH... *****&quot;</span> &lt;&lt; endl &lt;&lt; endl;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     vector&lt; Signature* &gt;::const_iterator sig;
<a name="l00078"></a>00078     <span class="keywordflow">for</span> (sig = <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.begin(); sig!=<a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.end(); sig++) {
<a name="l00079"></a>00079         <a class="code" href="class_device.html#a86a4d85b59e1f2256239c7fd383ad231">powerStateGraph</a>.<a class="code" href="class_power_state_graph.html#a90ebffe4864640182b342a814af0f0a7" title="Update or initialise Power State Graph.">update</a>( *(*sig) );
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     cout &lt;&lt; <span class="stringliteral">&quot;Mean energy consumption      = &quot;</span> &lt;&lt; <a class="code" href="class_device.html#a86a4d85b59e1f2256239c7fd383ad231">powerStateGraph</a>.<a class="code" href="class_power_state_graph.html#a1aff2c646dc8187249534520f8f7a4a1">getEnergyConsumption</a>().<a class="code" href="struct_statistic.html#ad2bc37d454c97cfd7187f767263ba208">mean</a> / <a class="code" href="_common_8h.html#a8b5d4090c9b2d51d2cc9d73f481cb893" title="Joules per kWh.">J_PER_KWH</a> &lt;&lt; <span class="stringliteral">&quot; kWh&quot;</span> &lt;&lt; endl;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     cout &lt;&lt; endl
<a name="l00085"></a>00085          &lt;&lt; <span class="stringliteral">&quot;Power State Graph vertices:&quot;</span> &lt;&lt; endl
<a name="l00086"></a>00086          &lt;&lt; <a class="code" href="class_device.html#a86a4d85b59e1f2256239c7fd383ad231">powerStateGraph</a> &lt;&lt; endl;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="comment">// output power state graph to file</span>
<a name="l00089"></a>00089     fstream fs;
<a name="l00090"></a>00090     <span class="keyword">const</span> <span class="keywordtype">string</span> psgFilename = <a class="code" href="_common_8h.html#a478275f2b00467a503a0b689f32e096f">DATA_OUTPUT_PATH</a> + <span class="stringliteral">&quot;powerStateGraph.gv&quot;</span>;
<a name="l00091"></a>00091     cout &lt;&lt; <span class="stringliteral">&quot;Outputting power state graph to &quot;</span> &lt;&lt; psgFilename &lt;&lt; endl;
<a name="l00092"></a>00092     <a class="code" href="namespace_utils.html#afb991f08a33e9d7f3298e60f3bf76960">Utils::openFile</a>(fs, psgFilename, fstream::out);
<a name="l00093"></a>00093     <a class="code" href="class_device.html#a86a4d85b59e1f2256239c7fd383ad231">powerStateGraph</a>.<a class="code" href="class_power_state_graph.html#a52095959446302223b8c436e1aa49e50" title="Information about an entire device &amp;#39;fingerprint&amp;#39; found in the aggregate data.">writeGraphViz</a>( fs );
<a name="l00094"></a>00094     fs.close();
<a name="l00095"></a>00095     <span class="keywordtype">string</span> dotCommand =
<a name="l00096"></a>00096             <span class="stringliteral">&quot;dot -Tpdf &quot;</span> + psgFilename + <span class="stringliteral">&quot; &gt; &quot;</span> + <a class="code" href="_common_8h.html#a478275f2b00467a503a0b689f32e096f">DATA_OUTPUT_PATH</a> + <span class="stringliteral">&quot;powerStateGraph.pdf&quot;</span>;
<a name="l00097"></a>00097     system( dotCommand.c_str() );
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="class_device.html#a89facf93091a42689e5b95968b6520b1">00100</a> <a class="code" href="class_power_state_graph.html" title="This class does most of the work behind the &amp;quot;graphs and spikes&amp;quot; disaggregation approach...">PowerStateGraph</a>&amp; <a class="code" href="class_device.html#a89facf93091a42689e5b95968b6520b1">Device::getPowerStateGraph</a>()
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102     <span class="keywordflow">return</span> <a class="code" href="class_device.html#a86a4d85b59e1f2256239c7fd383ad231">powerStateGraph</a>;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00111"></a><a class="code" href="class_device.html#a8899e5602a83445001c75fa885e29eb5">00111</a> <span class="keywordtype">void</span> <a class="code" href="class_device.html#a8899e5602a83445001c75fa885e29eb5">Device::getPowerStatesAndSequence</a>()
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     cout &lt;&lt; <span class="stringliteral">&quot;Running the code which was built for the \&quot;histograms\&quot; design iteration.\n&quot;</span>
<a name="l00114"></a>00114             <span class="stringliteral">&quot; This code only works with the last signature.  This code does not disaggregate;\n&quot;</span>
<a name="l00115"></a>00115             <span class="stringliteral">&quot; it creates a histogram from the signature, determines a set of power states \n&quot;</span>
<a name="l00116"></a>00116             <span class="stringliteral">&quot; and then creates a power state sequence.  The relevant graphs are output\n&quot;</span>
<a name="l00117"></a>00117             <span class="stringliteral">&quot; to &quot;</span> &lt;&lt; <a class="code" href="_common_8h.html#a478275f2b00467a503a0b689f32e096f">DATA_OUTPUT_PATH</a> &lt;&lt; endl &lt;&lt; endl;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     cout &lt;&lt; <span class="stringliteral">&quot;Determining power states...&quot;</span> &lt;&lt; endl;
<a name="l00120"></a>00120     <a class="code" href="class_device.html#a0fc31c44ec09adabef3b109917048b0e" title="Extract the power states from last signature and add them to this device&amp;#39;s powerStates.">updatePowerStates</a>();  <span class="comment">// old technique</span>
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     cout &lt;&lt; <span class="stringliteral">&quot;Determining power state sequence...&quot;</span> &lt;&lt; endl;
<a name="l00123"></a>00123     <a class="code" href="class_device.html#a255c62bedb8b90aaf4a60d2bed7d6017" title="Extract the power state sequence from last signature and add them to this device&amp;#39;s powerStates...">updatePowerStateSequence</a>();  <span class="comment">// old technique</span>
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00131"></a><a class="code" href="class_device.html#a0fc31c44ec09adabef3b109917048b0e">00131</a> <span class="keywordtype">void</span> <a class="code" href="class_device.html#a0fc31c44ec09adabef3b109917048b0e" title="Extract the power states from last signature and add them to this device&amp;#39;s powerStates.">Device::updatePowerStates</a>()
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     <span class="comment">// sanity check</span>
<a name="l00134"></a>00134     assert( ! <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.empty() );
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="comment">// get power states from last signatures</span>
<a name="l00137"></a>00137     <a class="code" href="class_device.html#a20a50f2f55cf6855c7d78efdd2a2e22a">powerStates</a> = <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.back()-&gt;getPowerStates();
<a name="l00138"></a>00138 
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00150"></a><a class="code" href="class_device.html#a255c62bedb8b90aaf4a60d2bed7d6017">00150</a> <span class="keywordtype">void</span> <a class="code" href="class_device.html#a255c62bedb8b90aaf4a60d2bed7d6017" title="Extract the power state sequence from last signature and add them to this device&amp;#39;s powerStates...">Device::updatePowerStateSequence</a>()
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <span class="comment">// sanity check</span>
<a name="l00153"></a>00153     assert( ! <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.empty() );
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="comment">// get power states from last signatures</span>
<a name="l00156"></a>00156     <a class="code" href="class_device.html#aa48173e8b62a5a21fca8833bb403bbe3">powerStateSequence</a> = <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.back()-&gt;getPowerStateSequence();
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     powerStateSequence.dumpToFile( <a class="code" href="class_device.html#ae779f5ee618677629b71287f3f77f8e8">name</a> );
<a name="l00159"></a>00159 
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00174"></a><a class="code" href="class_device.html#a54d749a3f88565a707388b3e5e8cf3fe">00174</a> <span class="keyword">const</span> list&lt;Signature::Spike&gt; <a class="code" href="class_device.html#a54d749a3f88565a707388b3e5e8cf3fe">Device::getSalientSpikes</a>()<span class="keyword"> const</span>
<a name="l00175"></a>00175 <span class="keyword"></span>{
<a name="l00176"></a>00176     <span class="comment">// get the gradient spikes for the first signature</span>
<a name="l00177"></a>00177     list&lt;Signature::Spike&gt; spikes = <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.front()-&gt;getDeltaSpikes();
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="comment">// take just the top ten (by absolute value)</span>
<a name="l00180"></a>00180     <span class="keywordflow">if</span> (spikes.size() &gt; 10) {
<a name="l00181"></a>00181         list&lt;Signature::Spike&gt;::iterator it = spikes.begin();
<a name="l00182"></a>00182         advance( it, 10 );
<a name="l00183"></a>00183         spikes.erase( it, spikes.end() );
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="comment">// re-order by index (i.e. by time)</span>
<a name="l00187"></a>00187     spikes.sort( <a class="code" href="struct_signature_1_1_spike.html#ad5c457fd1b72cd723bdf89f715f34abd">Signature::Spike::compareIndexAsc</a> );
<a name="l00188"></a>00188 
<a name="l00196"></a>00196     <span class="comment">// just for diagnostics:</span>
<a name="l00197"></a>00197 <span class="comment">/*    cout &lt;&lt; &quot;Salient spikes: \n&quot;</span>
<a name="l00198"></a>00198 <span class="comment">            &quot;index\tvalue\tduration&quot; &lt;&lt; endl;</span>
<a name="l00199"></a>00199 <span class="comment">    for(list&lt;Signature::Spike&gt;::const_iterator it=spikes.begin(); it!=spikes.end(); it++)</span>
<a name="l00200"></a>00200 <span class="comment">        cout &lt;&lt; it-&gt;index &lt;&lt; &quot;\t&quot; &lt;&lt; it-&gt;value &lt;&lt; &quot;\t&quot; &lt;&lt; it-&gt;duration &lt;&lt; endl;</span>
<a name="l00201"></a>00201 <span class="comment">*/</span>
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="keywordflow">return</span> spikes;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00214"></a><a class="code" href="class_device.html#a47fcd7e3c739ede14fdb27407d1b4481">00214</a> <span class="keyword">const</span> list&lt;size_t&gt; <a class="code" href="class_device.html#a47fcd7e3c739ede14fdb27407d1b4481">Device::getStartTimes</a>(
<a name="l00215"></a>00215         <span class="keyword">const</span> <a class="code" href="class_aggregate_data.html" title="This class is responsible for storing and searching aggregated data, such as the data produced by the...">AggregateData</a>&amp; aggregateData 
<a name="l00216"></a>00216         )<span class="keyword"> const</span>
<a name="l00217"></a>00217 <span class="keyword"></span>{
<a name="l00218"></a>00218     cout &lt;&lt; <span class="stringliteral">&quot;Getting start times for &quot;</span> &lt;&lt; <a class="code" href="class_device.html#ae779f5ee618677629b71287f3f77f8e8">name</a> &lt;&lt; endl;
<a name="l00219"></a>00219 
<a name="l00221"></a>00221     <span class="keyword">const</span> <span class="keywordtype">size_t</span> DIFF_THRESHOLD = 50; <span class="comment">// in Watts.  Difference between the size spike in the device signature and in the aggregate data.</span>
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     <a class="code" href="struct_device_1_1_index_and_delta.html">IndexAndDelta</a> indexAndDelta;
<a name="l00224"></a>00224     list&lt;size_t&gt; startTimes;
<a name="l00225"></a>00225     list&lt;IndexAndDelta&gt; candidates;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keyword">const</span> list&lt;Signature::Spike&gt; spikes = <a class="code" href="class_device.html#a54d749a3f88565a707388b3e5e8cf3fe">getSalientSpikes</a>();
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="comment">// try to find the first spike from &#39;spikes&#39; in the aggregateData</span>
<a name="l00230"></a>00230     <span class="keywordflow">for</span> (indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#aec236abe529ce24d5ef39ae6d7d1ba9a">index</a> = 0; indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#aec236abe529ce24d5ef39ae6d7d1ba9a">index</a> &lt; aggregateData.<a class="code" href="class_array.html#ae16b42080e87a53fe2b76af98995111b">getSize</a>(); indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#aec236abe529ce24d5ef39ae6d7d1ba9a">index</a>++) {
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#ae04bf070a39d1631973233d278e6f137">delta</a> =
<a name="l00233"></a>00233                 abs(aggregateData.<a class="code" href="class_aggregate_data.html#acdd54bd1cd18c492d43ab89474b0f8bb" title="Calculate the change between data[ i+1 ].reading and data[ i ].reading.">aggDelta</a>( indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#aec236abe529ce24d5ef39ae6d7d1ba9a">index</a> ) - spikes.front().delta);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#ae04bf070a39d1631973233d278e6f137">delta</a> &lt; DIFF_THRESHOLD) {
<a name="l00236"></a>00236             candidates.push_back( indexAndDelta );
<a name="l00237"></a>00237             cout &lt;&lt; indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#aec236abe529ce24d5ef39ae6d7d1ba9a">index</a> &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span>
<a name="l00238"></a>00238                     &lt;&lt; aggregateData.<a class="code" href="class_aggregate_data.html#a3c1068f43dcb228159ec5c76d355f1e8">secondsSinceFirstSample</a>(indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#aec236abe529ce24d5ef39ae6d7d1ba9a">index</a>) &lt;&lt; <span class="stringliteral">&quot;\t&quot;</span> &lt;&lt; indexAndDelta.<a class="code" href="struct_device_1_1_index_and_delta.html#ae04bf070a39d1631973233d278e6f137">delta</a> &lt;&lt; endl;
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="comment">// now try to find each of the other device signature spikes</span>
<a name="l00243"></a>00243     <span class="comment">// where we&#39;d expect to find them relative to the first spike</span>
<a name="l00244"></a>00244     <span class="keywordtype">size_t</span> expectedDistance, actualDistance;
<a name="l00245"></a>00245     list&lt;Signature::Spike&gt;::const_iterator spike;
<a name="l00246"></a>00246     <span class="keywordflow">for</span> (list&lt;IndexAndDelta&gt;::iterator candidate=candidates.begin();
<a name="l00247"></a>00247             candidate!=candidates.end();
<a name="l00248"></a>00248             candidate++) {
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         spike = spikes.begin();
<a name="l00251"></a>00251         advance( spike, 1 );
<a name="l00252"></a>00252         <span class="keywordflow">for</span> (; spike!=spikes.end(); spike++) {
<a name="l00253"></a>00253             expectedDistance = spike-&gt;index - spikes.front().index;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255             actualDistance = aggregateData.<a class="code" href="class_aggregate_data.html#a8f70bca861e1169bfecbf45936927506" title="Find &amp;#39;delta&amp;#39;. Start searching &amp;#39;expectedDistance&amp;#39; away from &amp;#39;candidateIndex&amp;#39;. DOESN&amp;#39;T WORK YET.">findNear</a>(
<a name="l00256"></a>00256                     candidate-&gt;index, expectedDistance, spike-&gt;delta );
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <span class="keywordflow">return</span> startTimes;
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00268"></a><a class="code" href="class_device.html#a821d5fa106be895802fff97c673ba633">00268</a> list&lt;size_t&gt; <a class="code" href="class_device.html#a821d5fa106be895802fff97c673ba633">Device::findAlignment</a>(
<a name="l00269"></a>00269         <span class="keyword">const</span> <a class="code" href="class_aggregate_data.html" title="This class is responsible for storing and searching aggregated data, such as the data produced by the...">AggregateData</a>&amp; aggData
<a name="l00270"></a>00270         )
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     cout &lt;&lt; endl
<a name="l00273"></a>00273          &lt;&lt; <span class="stringliteral">&quot;Attempting to find location of &quot;</span> &lt;&lt; <a class="code" href="class_device.html#ae779f5ee618677629b71287f3f77f8e8">name</a> &lt;&lt; <span class="stringliteral">&quot; in aggregate data.&quot;</span> &lt;&lt; endl;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     list&lt;size_t&gt; locations;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="comment">// Get a handy reference to the last &#39;rawReading&#39; stored in &#39;signatures&#39;</span>
<a name="l00278"></a>00278     <span class="keyword">const</span> <a class="code" href="class_array.html">Array&lt;Sample_t&gt;</a>&amp; sigArray = *(<a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.back());
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="keywordtype">double</span> min = numeric_limits&lt;double&gt;::max();
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="keywordtype">double</span> lms;
<a name="l00283"></a>00283     <span class="keywordtype">size_t</span> foundAt=0;
<a name="l00284"></a>00284     <span class="keyword">const</span> <span class="keywordtype">size_t</span> end =
<a name="l00285"></a>00285             aggData.<a class="code" href="class_array.html#ae16b42080e87a53fe2b76af98995111b">getSize</a>() -
<a name="l00286"></a>00286                 (sigArray.<a class="code" href="class_array.html#ae16b42080e87a53fe2b76af98995111b">getSize</a>() /
<a name="l00287"></a>00287                     (aggData.<a class="code" href="class_aggregate_data.html#aa0acfe59de5992e604497eb2a8942997">getSamplePeriod</a>() / <a class="code" href="class_device.html#a7e4fd5a2ef1640dc9786e6fb06290b68">signatures</a>.back()-&gt;getSamplePeriod() ));
<a name="l00288"></a>00288     <span class="keywordtype">size_t</span> i;
<a name="l00289"></a>00289     <span class="keywordflow">for</span> (i = 0; i &lt; end; i++) {
<a name="l00290"></a>00290         lms = <a class="code" href="class_device.html#ac99af11562629b3f90001e5415f5399a" title="Least mean difference.">LMS</a>(i, aggData, sigArray, aggData.<a class="code" href="class_aggregate_data.html#aa0acfe59de5992e604497eb2a8942997">getSamplePeriod</a>());
<a name="l00291"></a>00291         <span class="keywordflow">if</span> ( lms &lt; min ) {
<a name="l00292"></a>00292             min = lms;
<a name="l00293"></a>00293             foundAt = aggData[i].timestamp;
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     cout &lt;&lt; endl &lt;&lt; <a class="code" href="class_device.html#ae779f5ee618677629b71287f3f77f8e8">name</a> &lt;&lt; <span class="stringliteral">&quot; found at:&quot;</span> &lt;&lt; endl
<a name="l00298"></a>00298          &lt;&lt; <span class="stringliteral">&quot;  timestamp = &quot;</span> &lt;&lt; foundAt &lt;&lt; endl
<a name="l00299"></a>00299          &lt;&lt; <span class="stringliteral">&quot;  date      = &quot;</span> &lt;&lt; ctime( (time_t*)(&amp;foundAt) )
<a name="l00300"></a>00300          &lt;&lt; <span class="stringliteral">&quot;  LMS       = &quot;</span> &lt;&lt; min &lt;&lt; endl;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="keywordflow">return</span> locations;
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00315"></a><a class="code" href="class_device.html#ac99af11562629b3f90001e5415f5399a">00315</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="class_device.html#ac99af11562629b3f90001e5415f5399a" title="Least mean difference.">Device::LMS</a>(
<a name="l00316"></a>00316         <span class="keyword">const</span> <span class="keywordtype">size_t</span> aggOffset,
<a name="l00317"></a>00317         <span class="keyword">const</span> <a class="code" href="class_array.html">Array&lt;AggregateSample&gt;</a>&amp; aggData, 
<a name="l00318"></a>00318         <span class="keyword">const</span> <a class="code" href="class_array.html">Array&lt;Sample_t&gt;</a>&amp; sigArray,
<a name="l00319"></a>00319         <span class="keyword">const</span> <span class="keywordtype">size_t</span> aggDataSamplePeriod 
<a name="l00320"></a>00320         )
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322     <span class="keywordtype">double</span> accumulator = 0;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="comment">// THIS COMMENTED-OUT CODE ASSUMES THERE ARE NO MISSING SAMPLES.  I&#39;M KEEPING IT HERE FOR NOW</span>
<a name="l00325"></a>00325 <span class="comment">// BECAUSE IT&#39;S USEFUL FOR TESTING BY FINDING A CROPPED DEVICE SIGNATURE WITHIN ITSELF</span>
<a name="l00326"></a>00326 <span class="comment">//</span>
<a name="l00327"></a>00327 <span class="comment">//    for (i=0; i&lt;((sigArray.getSize()/aggDataSamplePeriod)-1); i++) {</span>
<a name="l00328"></a>00328 <span class="comment">//        for (size_t fineTune=0; fineTune&lt;aggDataSamplePeriod; fineTune++) {</span>
<a name="l00329"></a>00329 <span class="comment">//            accumulator += abs( sigArray[(i*aggDataSamplePeriod)+fineTune] - aggData[i+agOffset] );</span>
<a name="l00330"></a>00330 <span class="comment">//        }</span>
<a name="l00331"></a>00331 <span class="comment">//        accumulator += pow( ( sigArray[(i*aggDataSamplePeriod)] - aggData[i+agOffset] ) ,2);</span>
<a name="l00332"></a>00332 <span class="comment">//    }</span>
<a name="l00333"></a>00333 <span class="comment">//    cout &lt;&lt; &quot;i*aggDataSample=&quot; &lt;&lt; i*aggDataSamplePeriod &lt;&lt; &quot;sigArray.getSize()=&quot; &lt;&lt; sigArray.getSize() &lt;&lt; endl;</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="keywordtype">size_t</span> aggIndex=aggOffset, sigIndex=0, count=0;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="comment">// Take the first few readings to establish the level difference</span>
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="comment">// COMPARE START OF AGG DATA WITH START OF SIG DATA</span>
<a name="l00341"></a>00341     <span class="keywordflow">while</span> (sigIndex &lt; (sigArray.<a class="code" href="class_array.html#ae16b42080e87a53fe2b76af98995111b">getSize</a>()-aggDataSamplePeriod)
<a name="l00342"></a>00342             &amp;&amp; aggIndex &lt; (aggData.<a class="code" href="class_array.html#ae16b42080e87a53fe2b76af98995111b">getSize</a>()-1) &amp;&amp; count &lt; 50) {
<a name="l00343"></a>00343         accumulator += aggData[aggIndex].reading - sigArray[sigIndex]; <span class="comment">// don&#39;t take the absolute</span>
<a name="l00344"></a>00344         count++;
<a name="l00345"></a>00345         aggIndex++;
<a name="l00346"></a>00346         <span class="comment">// Inc sigIndex by however many seconds are between this and the previous aggData recording</span>
<a name="l00347"></a>00347         sigIndex += (aggData[aggIndex].timestamp - aggData[aggIndex-1].timestamp);
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <span class="comment">/*</span>
<a name="l00351"></a>00351 <span class="comment">    while (sigIndex &lt; (aggIndex &lt; (aggData.getSize()-1)) &amp;&amp; count &lt; 50) {</span>
<a name="l00352"></a>00352 <span class="comment">        accumulator += aggData[aggIndex].reading; // don&#39;t take the absolute</span>
<a name="l00353"></a>00353 <span class="comment">        count++;</span>
<a name="l00354"></a>00354 <span class="comment">        aggIndex++;</span>
<a name="l00355"></a>00355 <span class="comment">    }*/</span>
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="keywordtype">int</span> levelDiff = accumulator/count; <span class="comment">// -ve if sig is above aggregate</span>
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     accumulator = 0;
<a name="l00360"></a>00360     aggIndex=aggOffset;
<a name="l00361"></a>00361     sigIndex=0;
<a name="l00362"></a>00362     count=0;
<a name="l00363"></a>00363     <span class="keywordtype">double</span> diff;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keywordflow">while</span> (sigIndex &lt; (sigArray.<a class="code" href="class_array.html#ae16b42080e87a53fe2b76af98995111b">getSize</a>()-aggDataSamplePeriod) &amp;&amp; aggIndex &lt; (aggData.<a class="code" href="class_array.html#ae16b42080e87a53fe2b76af98995111b">getSize</a>()-1)) {
<a name="l00366"></a>00366             <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> fineTune = 0; fineTune&lt;aggDataSamplePeriod; fineTune++) {
<a name="l00367"></a>00367                 diff = (sigArray[sigIndex+fineTune]+levelDiff) - aggData[aggIndex].reading;
<a name="l00368"></a>00368                 accumulator += pow(diff,2);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370                 count++;
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372             aggIndex++;
<a name="l00373"></a>00373             <span class="comment">// Inc sigIndex by however many seconds are between this and the previous aggData recording</span>
<a name="l00374"></a>00374             sigIndex += (aggData[aggIndex].timestamp - aggData[aggIndex-1].timestamp);
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="keywordflow">return</span> accumulator / count; <span class="comment">// average</span>
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_device_8cpp.html">Device.cpp</a>      </li>
      <li class="footer">Generated on Fri Sep 9 2011 17:06:35 for Disaggregate by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
