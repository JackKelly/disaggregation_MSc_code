<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Disaggregate: /mnt/sshfs/imperialroot/homes/dk3810/workingcopies/disaggregate/src/Signature.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Disaggregate</div>
   <div id="projectbrief">Disaggregate Smart Meter data</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_signature_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Signature.cpp</h1>  </div>
</div>
<div class="contents">
<a href="_signature_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Signature.cpp</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> *  Created on: 5 Jul 2011</span>
<a name="l00005"></a>00005 <span class="comment"> *      Author: jack</span>
<a name="l00006"></a>00006 <span class="comment"> */</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &quot;<a class="code" href="_signature_8h.html">Signature.h</a>&quot;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &quot;<a class="code" href="_common_8h.html">Common.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &quot;<a class="code" href="_utils_8h.html">Utils.h</a>&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="_statistic_8h.html">Statistic.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="_device_8h.html">Device.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="_histogram_8h.html">Histogram.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;algorithm&gt;</span> <span class="comment">// for find</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keyword">using namespace </span>std;
<a name="l00023"></a>00023 
<a name="l00029"></a><a class="code" href="class_signature.html#a3ddd7b321b4eda212b310c8462febf3f">00029</a> <a class="code" href="class_signature.html#a3ddd7b321b4eda212b310c8462febf3f" title="Constructor for opening a CSV file.">Signature::Signature</a>(
<a name="l00030"></a>00030         <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; filename,       
<a name="l00031"></a>00031         <span class="keyword">const</span> <span class="keywordtype">size_t</span> _samplePeriod, 
<a name="l00032"></a>00032         <span class="keyword">const</span> <span class="keywordtype">string</span> _deviceName,   
<a name="l00033"></a>00033         <span class="keyword">const</span> <span class="keywordtype">size_t</span> _sigID,        
<a name="l00036"></a>00036         <span class="keyword">const</span> <span class="keywordtype">size_t</span> cropFront,     
<a name="l00040"></a>00040         <span class="keyword">const</span> <span class="keywordtype">size_t</span> cropBack       
<a name="l00044"></a>00044         )
<a name="l00045"></a>00045 : samplePeriod(_samplePeriod), sigID(_sigID)
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047     fstream dataFile;
<a name="l00048"></a>00048     <a class="code" href="namespace_utils.html#afb991f08a33e9d7f3298e60f3bf76960">Utils::openFile</a>( dataFile, filename, fstream::in );
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <a class="code" href="class_array.html">Array&lt;Sample_t&gt;</a> <a class="code" href="class_array.html#a1ed7a8632e383152e0f03c5eecf7e917">data</a>;
<a name="l00051"></a>00051     data.<a class="code" href="class_array.html#a16b3e6c252265356859eea3843afa84c" title="Load data from a CSV file with a single column.">loadData</a>( dataFile );
<a name="l00052"></a>00052     dataFile.close();
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     <span class="keywordtype">size_t</span> newCropFront = cropFront ? cropFront : data.<a class="code" href="class_array.html#a6a96fa1422cb1353a86173f82f13940e">getNumLeadingZeros</a>();
<a name="l00055"></a>00055     <span class="keywordtype">size_t</span> newCropBack  = cropBack  ? cropBack  : data.<a class="code" href="class_array.html#a2161aca5d07d156bdf15bc8d098fe054">getNumTrailingZeros</a>();
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     <a class="code" href="class_array.html#ae68b00a51265644510bc23945960561e" title="Copy from source to this object, starting at cropFront index and ignoring the last cropBack items fro...">copyCrop</a>( data, newCropFront, newCropBack );
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <a class="code" href="class_array.html#ae76d8979a96f9af21f89770700ac3710" title="Most arrays are associated with a device. If not, just leave blank.">deviceName</a> =_deviceName;
<a name="l00060"></a>00060     <a class="code" href="class_signature.html#a894694ae2be0036ddfb4a84b87f9649e">powerStateSequence</a>.<a class="code" href="class_power_state_sequence.html#af6cb14df9881d4dea2256640fe52c26b">setDeviceName</a>( <a class="code" href="class_array.html#ae76d8979a96f9af21f89770700ac3710" title="Most arrays are associated with a device. If not, just leave blank.">deviceName</a> );
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     <span class="comment">// Draw graph of raw data after cropping</span>
<a name="l00063"></a>00063     <a class="code" href="class_signature.html#a3d3b6a270b3f38922568438690096237">drawGraph</a>( <span class="stringliteral">&quot;-afterCropping&quot;</span> );
<a name="l00064"></a>00064 
<a name="l00065"></a>00065     <a class="code" href="class_array.html">Array&lt;Sample_t&gt;</a> delta;
<a name="l00066"></a>00066     <a class="code" href="class_array.html#adeb6ee31eaa806644ce52552b8fc8bc1">getDelta</a>( &amp;delta );
<a name="l00067"></a>00067     delta.<a class="code" href="class_array.html#acc8d9358f9cc9fa7d10d5010099cbc10">drawGraph</a>( <span class="stringliteral">&quot;-delta&quot;</span> );
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 }
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="class_signature.html#ad0bb12039b385e4600dddc7d703f52fb">00071</a> <a class="code" href="class_signature.html#ad0bb12039b385e4600dddc7d703f52fb">Signature::~Signature</a>()
<a name="l00072"></a>00072 {}
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="class_signature.html#a3d3b6a270b3f38922568438690096237">00075</a> <span class="keywordtype">void</span> <a class="code" href="class_signature.html#a3d3b6a270b3f38922568438690096237">Signature::drawGraph</a>(
<a name="l00076"></a>00076         <span class="keyword">const</span> <span class="keywordtype">string</span> details 
<a name="l00078"></a>00078         )<span class="keyword"> const</span>
<a name="l00079"></a>00079 <span class="keyword"></span>{
<a name="l00080"></a>00080     <a class="code" href="class_signature.html#a3d3b6a270b3f38922568438690096237">Array&lt;Sample_t&gt;::drawGraph</a>(
<a name="l00081"></a>00081             details,
<a name="l00082"></a>00082             <span class="stringliteral">&quot;time (seconds)&quot;</span>,
<a name="l00083"></a>00083             <span class="stringliteral">&quot;power (kW)&quot;</span>
<a name="l00084"></a>00084             );
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="class_signature.html#a80ab9f3c989f356fd8fd61282de3a994">00087</a> <span class="keywordtype">void</span> <a class="code" href="class_signature.html#a80ab9f3c989f356fd8fd61282de3a994">Signature::drawHistWithStateBars</a>(
<a name="l00088"></a>00088         <span class="keyword">const</span> <a class="code" href="class_histogram.html">Histogram</a>&amp; hist 
<a name="l00089"></a>00089     )<span class="keyword"> const</span>
<a name="l00090"></a>00090 <span class="keyword"></span>{
<a name="l00091"></a>00091     <span class="comment">// Dump histogram data to a .dat file</span>
<a name="l00092"></a>00092     hist.<a class="code" href="class_array.html#a6ef27596ae6f5cd98001ca8ba7b13038">dumpToFile</a>( hist.<a class="code" href="class_histogram.html#ac542b993b1f5a0ab1b94d4ee7b0bb70d">getBaseFilename</a>() );
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     <span class="comment">// Set plot variables</span>
<a name="l00095"></a>00095     <a class="code" href="struct_g_n_uplot_1_1_plot_vars.html" title="Structure for storing variables destined for a GNUplot script.">GNUplot::PlotVars</a> pv;
<a name="l00096"></a>00096     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#a47a2ff80fa9744de494d7f0704899d16" title="template filename (without suffix or path). Directory hard-coded to be &amp;#39;/config&amp;#39;.">inFilename</a>  = <span class="stringliteral">&quot;histWithStateBars&quot;</span>;
<a name="l00097"></a>00097     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#a52a9c2f3ffc0d107e608d2449657ea50" title="output filename (without suffix or path). Directory = DATA_OUTPUT_PATH config option.">outFilename</a> = <a class="code" href="class_array.html#ae76d8979a96f9af21f89770700ac3710" title="Most arrays are associated with a device. If not, just leave blank.">deviceName</a> + <span class="stringliteral">&quot;-histWithStateBars&quot;</span>;
<a name="l00098"></a>00098     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#a1c2d88ef7283190b19c656ccf36d426a" title="Graph title.">title</a>       = <a class="code" href="class_array.html#ae76d8979a96f9af21f89770700ac3710" title="Most arrays are associated with a device. If not, just leave blank.">deviceName</a> + <span class="stringliteral">&quot; histogram with state bars.&quot;</span>;
<a name="l00099"></a>00099     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#a259c83d971edf0d273c73b70241385b4">xlabel</a>      = <span class="stringliteral">&quot;power (Watts)&quot;</span>;
<a name="l00100"></a>00100     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#ab863db5d87f776ce50631876e5f949b0">ylabel</a>      = <span class="stringliteral">&quot;histogram frequency&quot;</span>;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="comment">// Set data for plotting</span>
<a name="l00103"></a>00103     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#a9a2dcfdc29af89100641d4f035312aea" title="List of data elements to be plotted.">data</a>.push_back( <a class="code" href="struct_g_n_uplot_1_1_plot_data.html" title="Structure for storing details about data elements to be plotted.">GNUplot::PlotData</a>(
<a name="l00104"></a>00104             hist.<a class="code" href="class_histogram.html#ac542b993b1f5a0ab1b94d4ee7b0bb70d">getBaseFilename</a>(),
<a name="l00105"></a>00105             <span class="stringliteral">&quot;Histogram. HistSmoothing = &quot;</span> + <a class="code" href="namespace_utils.html#a48dfa27103961c7cc6082f7e68857748">Utils::size_t_to_s</a>( hist.<a class="code" href="class_array.html#ae80fff561b788262683b42941f2ebda5">getSmoothing</a>() ) +
<a name="l00106"></a>00106                  <span class="stringliteral">&quot;. UpstreamSmoothing=&quot;</span> + <a class="code" href="namespace_utils.html#a48dfa27103961c7cc6082f7e68857748">Utils::size_t_to_s</a>( hist.<a class="code" href="class_array.html#a7ba19720014d5acbdc165dee31686bd3">getUpstreamSmoothing</a>() ),
<a name="l00107"></a>00107             <span class="stringliteral">&quot;HIST&quot;</span> )
<a name="l00108"></a>00108     );
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#a9a2dcfdc29af89100641d4f035312aea" title="List of data elements to be plotted.">data</a>.push_back( <a class="code" href="struct_g_n_uplot_1_1_plot_data.html" title="Structure for storing details about data elements to be plotted.">GNUplot::PlotData</a> (
<a name="l00111"></a>00111             hist.<a class="code" href="class_array.html#a142bd1adb0eb622a1d89e6ca514509c0">getSmoothedGradOfHistFilename</a>(),
<a name="l00112"></a>00112             <span class="stringliteral">&quot;Gradient of histogram. Gradient smoothing=&quot;</span> + <a class="code" href="namespace_utils.html#a48dfa27103961c7cc6082f7e68857748">Utils::size_t_to_s</a>( hist.<a class="code" href="class_array.html#aa285ca798ba19cf8f858395d845cdb78" title="Length of rolling average of histogram gradient. Best if odd.">HIST_GRADIENT_RA_LENGTH</a> ),
<a name="l00113"></a>00113             <span class="stringliteral">&quot;HISTGRAD&quot;</span> )
<a name="l00114"></a>00114     );
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     pv.<a class="code" href="struct_g_n_uplot_1_1_plot_vars.html#a9a2dcfdc29af89100641d4f035312aea" title="List of data elements to be plotted.">data</a>.push_back( <a class="code" href="struct_g_n_uplot_1_1_plot_data.html" title="Structure for storing details about data elements to be plotted.">GNUplot::PlotData</a>(
<a name="l00117"></a>00117             <a class="code" href="class_signature.html#a6e3fba4e40182e955f5d475553f401c5">getStateBarsBaseFilename</a>(),
<a name="l00118"></a>00118             <span class="stringliteral">&quot;Automatically determined power states (min, mean, max)&quot;</span>,
<a name="l00119"></a>00119             <span class="stringliteral">&quot;STATES&quot;</span> )
<a name="l00120"></a>00120     );
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">// Plot</span>
<a name="l00123"></a>00123     <a class="code" href="namespace_g_n_uplot.html#ab276a6d946560395f9d6caa8cb6cb640" title="Plot a graph using GNUplot.">GNUplot::plot</a>( pv );
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a><a class="code" href="class_signature.html#ada861d4b0e402605478abc4217f35979">00127</a> <span class="keyword">const</span> <a class="code" href="_power_state_sequence_8h.html#a625b9539d5938514b28ab4d0791112f3">PowerStates_t</a>&amp; <a class="code" href="class_signature.html#ada861d4b0e402605478abc4217f35979">Signature::getPowerStates</a>()
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129     <span class="keywordflow">if</span> ( <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.empty() )
<a name="l00130"></a>00130         <a class="code" href="class_signature.html#afebb6e34dcba3d828093eba1ffc7fad6" title="Runs through signature data to find power states and stores the resulting power states in powerStates...">updatePowerStates</a>();
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="keywordflow">return</span> <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00142"></a><a class="code" href="class_signature.html#afebb6e34dcba3d828093eba1ffc7fad6">00142</a> <span class="keywordtype">void</span> <a class="code" href="class_signature.html#afebb6e34dcba3d828093eba1ffc7fad6" title="Runs through signature data to find power states and stores the resulting power states in powerStates...">Signature::updatePowerStates</a>()
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144     assert ( <a class="code" href="class_array.html#ab1dd0b3a06b008bf93de58d1194a554a" title="Number of members. size_t is 8bytes wide on x86_64.">size</a> ); <span class="comment">// make sure Signature is populated</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     <span class="comment">// Smooth raw data</span>
<a name="l00147"></a>00147     <a class="code" href="class_array.html">Array&lt;Sample_t&gt;</a> RA; <span class="comment">// array to hold rolling average</span>
<a name="l00148"></a>00148     <a class="code" href="class_array.html#a6603ebeb68bb0c1b493f0808d5694498" title="Returns a rolling average of same length as the original array.">rollingAv</a>( &amp;RA, <a class="code" href="class_signature.html#af7cb9d637a46f58b3fe9617805d24a75">PREPROCESSING_DATA_SMOOTHING</a> );
<a name="l00149"></a>00149     RA.<a class="code" href="class_array.html#acc8d9358f9cc9fa7d10d5010099cbc10">drawGraph</a>( <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;time (seconds)&quot;</span>, <span class="stringliteral">&quot;power (Watts)&quot;</span>, <span class="stringliteral">&quot;&quot;</span> ); 
<a name="l00151"></a>00151     <span class="comment">// Create histogram from smoothed data</span>
<a name="l00152"></a>00152     <a class="code" href="class_histogram.html">Histogram</a> hist ( RA );
<a name="l00153"></a>00153     hist.<a class="code" href="class_histogram.html#ad4a2b931c86c4a7f2ce465d0c737050f">drawGraph</a>();
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="comment">// find the boundaries of the different power states in the histogram</span>
<a name="l00156"></a>00156     std::list&lt;size_t&gt; boundaries;
<a name="l00157"></a>00157     hist.<a class="code" href="class_array.html#ad09653725c36dbb022a04309465ec277" title="Attempts to automatically find the peaks.">findPeaks</a>( &amp;boundaries );
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">// calculate proper stats for power states...</span>
<a name="l00160"></a>00160     <span class="comment">// Go through each pair of boundaries, working out stats for each</span>
<a name="l00161"></a>00161     assert( (boundaries.size() % 2)==0 ); <span class="comment">// check there&#39;s an even number of entries</span>
<a name="l00162"></a>00162     <span class="keywordtype">size_t</span> front, back;
<a name="l00163"></a>00163     fstream dataFile;
<a name="l00164"></a>00164     <a class="code" href="namespace_utils.html#afb991f08a33e9d7f3298e60f3bf76960">Utils::openFile</a>( dataFile, <a class="code" href="_common_8h.html#a478275f2b00467a503a0b689f32e096f">DATA_OUTPUT_PATH</a> + <a class="code" href="class_signature.html#a6e3fba4e40182e955f5d475553f401c5">getStateBarsBaseFilename</a>() + <span class="stringliteral">&quot;.dat&quot;</span>, fstream::out );
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="keywordflow">for</span> (std::list&lt;size_t&gt;::const_iterator it=boundaries.begin(); it!=boundaries.end(); it++) {
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         front = *it;
<a name="l00169"></a>00169         back  = *(++it);
<a name="l00170"></a>00170 
<a name="l00171"></a>00171         <a class="code" href="struct_statistic.html">PowerState_t</a> thisPowerState( hist, front, back );
<a name="l00172"></a>00172         <span class="keywordflow">if</span> (thisPowerState.<a class="code" href="struct_statistic.html#a7e5018f42ba5251ab4070db70881878c">numDataPoints</a> &gt; 5) {  <span class="comment">// if numDataPoints is really low then we don&#39;t care about this powerState</span>
<a name="l00173"></a>00173             <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.push_back( thisPowerState );
<a name="l00174"></a>00174             std::cout &lt;&lt; <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.back() &lt;&lt; std::endl;
<a name="l00175"></a>00175             <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.back().outputStateBarsLine( dataFile );
<a name="l00176"></a>00176         }
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178     dataFile.close();
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <a class="code" href="class_signature.html#a80ab9f3c989f356fd8fd61282de3a994">drawHistWithStateBars</a>( hist );
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="class_signature.html#a6e3fba4e40182e955f5d475553f401c5">00183</a> <span class="keyword">const</span> <span class="keywordtype">string</span> <a class="code" href="class_signature.html#a6e3fba4e40182e955f5d475553f401c5">Signature::getStateBarsBaseFilename</a>()<span class="keyword"> const</span>
<a name="l00184"></a>00184 <span class="keyword"></span>{
<a name="l00185"></a>00185     <span class="keywordflow">return</span> <a class="code" href="class_array.html#ae76d8979a96f9af21f89770700ac3710" title="Most arrays are associated with a device. If not, just leave blank.">deviceName</a> + <span class="stringliteral">&quot;-stateBars&quot;</span>;
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00193"></a><a class="code" href="class_signature.html#ad8e91ae22a37b43dcddc83194b969108">00193</a> <span class="keywordtype">void</span> <a class="code" href="class_signature.html#ad8e91ae22a37b43dcddc83194b969108" title="Fill in gaps in the powerStates so that each powerState in the list is nose-to-tail.">Signature::fillGapsInPowerStates</a>(
<a name="l00194"></a>00194         <span class="keyword">const</span> <a class="code" href="class_histogram.html">Histogram</a>&amp; hist,
<a name="l00195"></a>00195         <span class="keyword">const</span> <span class="keywordtype">bool</span> verbose
<a name="l00196"></a>00196         )
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     assert( ! <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.empty() );
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     PowerStates_t::iterator prevPowerState,
<a name="l00201"></a>00201                             powerState;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     prevPowerState = powerState = <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.begin();
<a name="l00204"></a>00204     powerState++;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="keywordflow">for</span> ( ; powerState!=<a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.end(); powerState++) {
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (powerState-&gt;min != prevPowerState-&gt;max &amp;&amp;
<a name="l00209"></a>00209             powerState-&gt;min != (prevPowerState-&gt;max + 1) ) {
<a name="l00210"></a>00210             <span class="comment">// &#39;prevPowerState&#39; and this &#39;powerState&#39; are not nose-to-tail so insert a new power state</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212             <span class="keywordflow">if</span> (verbose) cout &lt;&lt; <span class="stringliteral">&quot;Inserting new power state between &quot;</span> &lt;&lt; prevPowerState-&gt;max &lt;&lt; <span class="stringliteral">&quot; and &quot;</span> &lt;&lt; powerState-&gt;min &lt;&lt; endl;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214             <span class="comment">// Insert new powerState before current powerState</span>
<a name="l00215"></a>00215             <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.insert( powerState,
<a name="l00216"></a>00216                                 <a class="code" href="_power_state_sequence_8h.html#a3a9d41f33e71e16d2f0ff9a5a9e5c78b">PowerState_t</a>( hist, (prevPowerState-&gt;max + 1), powerState-&gt;min ) );
<a name="l00217"></a>00217         } <span class="comment">// end if</span>
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         prevPowerState = powerState;
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="comment">// deal with case where final powerState still doesn&#39;t cover upper range</span>
<a name="l00223"></a>00223     <span class="keywordflow">if</span> (prevPowerState-&gt;max != <a class="code" href="_common_8h.html#a829760c43a330e65003be7ff2e85571b" title="Maximum wattage allowed in DEVICE_RAW_DATA files.">MAX_WATTAGE</a>) {
<a name="l00224"></a>00224         <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.push_back( <a class="code" href="_power_state_sequence_8h.html#a3a9d41f33e71e16d2f0ff9a5a9e5c78b">PowerState_t</a>( hist, (prevPowerState-&gt;max + 1), <a class="code" href="_common_8h.html#a829760c43a330e65003be7ff2e85571b" title="Maximum wattage allowed in DEVICE_RAW_DATA files.">MAX_WATTAGE</a> ) );
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="comment">// debugging code</span>
<a name="l00228"></a>00228     <span class="keywordflow">for</span> (powerState = <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.begin(); powerState!=<a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.end(); powerState++) {
<a name="l00229"></a>00229         cout &lt;&lt; <span class="stringliteral">&quot;Power state = &quot;</span> &lt;&lt; *powerState &lt;&lt; std::endl;
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 
<a name="l00235"></a><a class="code" href="class_signature.html#abf3dc6265e852ecb66a928c682e3eb5f">00235</a> <span class="keyword">const</span> <a class="code" href="class_power_state_sequence.html">PowerStateSequence</a>&amp; <a class="code" href="class_signature.html#abf3dc6265e852ecb66a928c682e3eb5f">Signature::getPowerStateSequence</a>()
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237     <span class="keywordflow">if</span> ( <a class="code" href="class_signature.html#a894694ae2be0036ddfb4a84b87f9649e">powerStateSequence</a>.empty() )
<a name="l00238"></a>00238         <a class="code" href="class_signature.html#af94cd3aa816030f1560410e4ad6f2dcc" title="Finding out where each &amp;#39;powerState&amp;#39; starts and ends.">updatePowerStateSequence</a>();
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keywordflow">return</span> <a class="code" href="class_signature.html#a894694ae2be0036ddfb4a84b87f9649e">powerStateSequence</a>;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00248"></a><a class="code" href="class_signature.html#af94cd3aa816030f1560410e4ad6f2dcc">00248</a> <span class="keywordtype">void</span> <a class="code" href="class_signature.html#af94cd3aa816030f1560410e4ad6f2dcc" title="Finding out where each &amp;#39;powerState&amp;#39; starts and ends.">Signature::updatePowerStateSequence</a>()
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250     cout &lt;&lt; <span class="stringliteral">&quot;Getting power state sequence for &quot;</span> &lt;&lt; <a class="code" href="class_array.html#ae76d8979a96f9af21f89770700ac3710" title="Most arrays are associated with a device. If not, just leave blank.">deviceName</a> &lt;&lt; <span class="stringliteral">&quot;...&quot;</span> &lt;&lt; endl;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="comment">// sanity check</span>
<a name="l00253"></a>00253     assert( ! <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.empty() );
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="comment">// Smooth data</span>
<a name="l00256"></a>00256     <a class="code" href="class_array.html">Array&lt;Sample_t&gt;</a> RA; <span class="comment">// array to hold rolling average</span>
<a name="l00257"></a>00257     <a class="code" href="class_array.html#a6603ebeb68bb0c1b493f0808d5694498" title="Returns a rolling average of same length as the original array.">rollingAv</a>( &amp;RA, <a class="code" href="class_signature.html#af7cb9d637a46f58b3fe9617805d24a75">PREPROCESSING_DATA_SMOOTHING</a> );
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <a class="code" href="struct_power_state_sequence_item.html">PowerStateSequenceItem</a> powerStateSequenceItem;
<a name="l00260"></a>00260     PowerStates_t::const_iterator currentPowerState;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <span class="keyword">enum</span> { WITHIN_STATE, NO_MANS_LAND } state;
<a name="l00263"></a>00263     state = NO_MANS_LAND;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <span class="comment">// Go through raw reading finding occurrences of each power state</span>
<a name="l00266"></a>00266     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;RA.getSize(); i++ ) {
<a name="l00267"></a>00267         currentPowerState = <a class="code" href="class_signature.html#ad298320a4b490ba402d3f5489ce3651a">getPowerState</a>( RA[i] );
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">switch</span> (state) {
<a name="l00270"></a>00270         <span class="keywordflow">case</span> WITHIN_STATE:
<a name="l00271"></a>00271             <span class="keywordflow">if</span> (currentPowerState != powerStateSequenceItem.<a class="code" href="struct_power_state_sequence_item.html#a7124d796f1de184a581f445827efe105" title="An iterator &amp;quot;pointer&amp;quot; to a powerState.">powerState</a>) {
<a name="l00272"></a>00272                         <span class="comment">// then we&#39;ve hit a powerState transition</span>
<a name="l00273"></a>00273                         <span class="comment">// so store the details of the powerState we&#39;ve just left</span>
<a name="l00274"></a>00274                         powerStateSequenceItem.<a class="code" href="struct_power_state_sequence_item.html#a844bc1092ecb5859603f6e6cdfbb124d" title="in seconds">endTime</a>   = i*<a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00275"></a>00275                         <a class="code" href="class_signature.html#a894694ae2be0036ddfb4a84b87f9649e">powerStateSequence</a>.push_back( powerStateSequenceItem ); <span class="comment">// save a copy</span>
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="comment">/*                        cout &lt;&lt; &quot;Power state transition. start=&quot; &lt;&lt; powerStateSequenceItem.startTime</span>
<a name="l00278"></a>00278 <span class="comment">                                &lt;&lt; &quot;\tendTime=&quot; &lt;&lt; powerStateSequenceItem.endTime</span>
<a name="l00279"></a>00279 <span class="comment">                                &lt;&lt; &quot;\tduration=&quot; &lt;&lt; powerStateSequenceItem.endTime - powerStateSequenceItem.startTime</span>
<a name="l00280"></a>00280 <span class="comment">                                &lt;&lt; &quot;\t&quot; &lt;&lt; *powerStateSequenceItem.powerState &lt;&lt; endl; */</span>
<a name="l00281"></a>00281 
<a name="l00282"></a>00282                         <span class="keywordflow">if</span> ( currentPowerState == <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.end() ) {
<a name="l00283"></a>00283                             <span class="comment">// We&#39;ve entered an unrecognised state</span>
<a name="l00284"></a>00284                             state = NO_MANS_LAND;
<a name="l00285"></a>00285                         } <span class="keywordflow">else</span> {
<a name="l00286"></a>00286                             <span class="comment">// We&#39;ve transitioned directly from one recognised state to another</span>
<a name="l00287"></a>00287                             powerStateSequenceItem.<a class="code" href="struct_power_state_sequence_item.html#a7124d796f1de184a581f445827efe105" title="An iterator &amp;quot;pointer&amp;quot; to a powerState.">powerState</a> = currentPowerState;
<a name="l00288"></a>00288                             powerStateSequenceItem.<a class="code" href="struct_power_state_sequence_item.html#ae1fd838b2e9222265c654b4b303505b0" title="in seconds">startTime</a>  = i*<a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00289"></a>00289                         }
<a name="l00290"></a>00290             }
<a name="l00291"></a>00291             <span class="keywordflow">break</span>;
<a name="l00292"></a>00292         <span class="keywordflow">case</span> NO_MANS_LAND:
<a name="l00293"></a>00293             <span class="keywordflow">if</span> ( currentPowerState != <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.end() ) {
<a name="l00294"></a>00294                 <span class="comment">// We&#39;ve entered a recognised state</span>
<a name="l00295"></a>00295                 state = WITHIN_STATE;
<a name="l00296"></a>00296                 powerStateSequenceItem.<a class="code" href="struct_power_state_sequence_item.html#a7124d796f1de184a581f445827efe105" title="An iterator &amp;quot;pointer&amp;quot; to a powerState.">powerState</a> = currentPowerState;
<a name="l00297"></a>00297                 powerStateSequenceItem.<a class="code" href="struct_power_state_sequence_item.html#ae1fd838b2e9222265c654b4b303505b0" title="in seconds">startTime</a>  = i*<a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00298"></a>00298             }
<a name="l00299"></a>00299             <span class="keywordflow">break</span>;
<a name="l00300"></a>00300         };
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <span class="comment">// Handle case where final state is left hanging after for loop</span>
<a name="l00304"></a>00304     <span class="keywordflow">if</span> ( state == WITHIN_STATE ) {
<a name="l00305"></a>00305         powerStateSequenceItem.<a class="code" href="struct_power_state_sequence_item.html#a844bc1092ecb5859603f6e6cdfbb124d" title="in seconds">endTime</a> = RA.getSize()*<a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00306"></a>00306         <a class="code" href="class_signature.html#a894694ae2be0036ddfb4a84b87f9649e">powerStateSequence</a>.push_back( powerStateSequenceItem ); <span class="comment">// save a copy</span>
<a name="l00307"></a>00307 <span class="comment">//        cout &lt;&lt; &quot;Power state transition. start=&quot; &lt;&lt; powerStateSequenceItem.startTime</span>
<a name="l00308"></a>00308 <span class="comment">//                &lt;&lt; &quot;\tendTime=&quot; &lt;&lt; powerStateSequenceItem.endTime</span>
<a name="l00309"></a>00309 <span class="comment">//                &lt;&lt; &quot;\tduration=&quot; &lt;&lt; powerStateSequenceItem.endTime - powerStateSequenceItem.startTime</span>
<a name="l00310"></a>00310 <span class="comment">//                &lt;&lt; &quot;\t&quot; &lt;&lt; *powerStateSequenceItem.powerState &lt;&lt; endl;</span>
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     cout &lt;&lt; <span class="stringliteral">&quot;...done getting power state sequence for &quot;</span> &lt;&lt; <a class="code" href="class_array.html#ae76d8979a96f9af21f89770700ac3710" title="Most arrays are associated with a device. If not, just leave blank.">deviceName</a> &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; endl;
<a name="l00314"></a>00314     <a class="code" href="class_signature.html#a894694ae2be0036ddfb4a84b87f9649e">powerStateSequence</a>.<a class="code" href="class_power_state_sequence.html#a52cd95f5d505d6e199eb96fb488b4658">plotGraph</a>();
<a name="l00315"></a>00315 
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 
<a name="l00324"></a><a class="code" href="class_signature.html#ad298320a4b490ba402d3f5489ce3651a">00324</a> PowerStates_t::const_iterator <a class="code" href="class_signature.html#ad298320a4b490ba402d3f5489ce3651a">Signature::getPowerState</a>( <span class="keyword">const</span> <a class="code" href="_common_8h.html#a735a41e7f307845b3589becd721cccaa" title="An individual sample (as recorded by a CurrentCost or WattsUp)">Sample_t</a> sample )<span class="keyword"> const</span>
<a name="l00325"></a>00325 <span class="keyword"></span>{
<a name="l00326"></a>00326     <span class="comment">// sanity check</span>
<a name="l00327"></a>00327     assert( ! <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.empty() );
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="comment">// Doing the inelegant, brute-force approach</span>
<a name="l00330"></a>00330     <span class="keywordflow">for</span> (PowerStates_t::const_iterator powerState = <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.begin();
<a name="l00331"></a>00331          powerState != <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.end();
<a name="l00332"></a>00332          powerState++) {
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         <span class="keywordflow">if</span> ( <a class="code" href="namespace_utils.html#a17211384a3579f952022415556bcda62">Utils::roundToNearestInt</a>(sample) &lt;= powerState-&gt;max &amp;&amp;
<a name="l00335"></a>00335              <a class="code" href="namespace_utils.html#a17211384a3579f952022415556bcda62">Utils::roundToNearestInt</a>(sample) &gt;= powerState-&gt;min ) {
<a name="l00336"></a>00336             <span class="keywordflow">return</span> powerState;
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="comment">// If we get to here then &#39;sample&#39; does not fall within any powerState boundary</span>
<a name="l00341"></a>00341     <span class="keywordflow">return</span> <a class="code" href="class_signature.html#af68001cd3c4e0c447213f3d38e9eabcb">powerStates</a>.end();
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 
<a name="l00353"></a><a class="code" href="class_signature.html#a02acc8e9f1ceb1af2908807eb1526fcd">00353</a> <span class="keyword">const</span> list&lt;Signature::Spike&gt; <a class="code" href="class_signature.html#a02acc8e9f1ceb1af2908807eb1526fcd" title="Takes the gradient of this Signature, then merges gradient values with the same sign, then removes transient spikes, then sorts by value.">Signature::getDeltaSpikes</a>(
<a name="l00354"></a>00354         <span class="keyword">const</span> <span class="keywordtype">size_t</span> LOOK_AHEAD  
<a name="l00356"></a>00356     )<span class="keyword"> const</span>
<a name="l00357"></a>00357 <span class="keyword"></span>{
<a name="l00358"></a>00358     <span class="comment">// CONSTANTS</span>
<a name="l00359"></a>00359     <span class="keyword">const</span> <span class="keywordtype">double</span> LOOK_AHEAD_TOLLERANCE = 0.2; <span class="comment">// what qualifies as a &quot;similar sized&quot; spike? 0==exactly equal.  0.1==within 10% of first spike&#39;s value.</span>
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <span class="comment">// LOCAL VARIABLES</span>
<a name="l00362"></a>00362     list&lt;Spike&gt;::iterator  spike, lookAhead;
<a name="l00363"></a>00363     list&lt;Spike&gt; mergedSpikes = <a class="code" href="class_signature.html#a6bf289b7aa40eb2791d13d8669089953" title="Merge consecutive spikes of the same sign and then remove any spikes under 10 Watts.">getMergedSpikes</a>();
<a name="l00364"></a>00364     <span class="keywordtype">bool</span> found;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <span class="comment">/* Remove fleetingly transient spikes */</span>
<a name="l00367"></a>00367     spike = mergedSpikes.begin();
<a name="l00368"></a>00368     <span class="keywordflow">while</span> ( spike != mergedSpikes.end() ) {
<a name="l00369"></a>00369         <span class="comment">// Check spike isn&#39;t fleetingly transient</span>
<a name="l00370"></a>00370         lookAhead = spike;
<a name="l00371"></a>00371         advance( lookAhead, 1 );
<a name="l00372"></a>00372         <span class="comment">/* Look ahead to see if there&#39;s a spike of opposite sign and similar magnitude</span>
<a name="l00373"></a>00373 <span class="comment">         * within LOOK_AHEAD samples.     */</span>
<a name="l00374"></a>00374         found = <span class="keyword">false</span>;
<a name="l00375"></a>00375         <span class="keywordflow">while</span> ( lookAhead!=mergedSpikes.end() &amp;&amp; (lookAhead-&gt;index - spike-&gt;index)&lt;LOOK_AHEAD ) {
<a name="l00376"></a>00376             <span class="keywordflow">if</span> ( <a class="code" href="namespace_utils.html#a64df1cf745416e01ed1b1d0618d4cdfa" title="Compares 2 doubles. Are they within (a * tolerance) of each other?">Utils::roughlyEqual</a>( spike-&gt;delta, -lookAhead-&gt;delta, LOOK_AHEAD_TOLLERANCE ) ) {
<a name="l00377"></a>00377                 mergedSpikes.erase( lookAhead++ );
<a name="l00378"></a>00378                 mergedSpikes.erase( spike++ );
<a name="l00379"></a>00379                 found = <span class="keyword">true</span>;
<a name="l00380"></a>00380                 <span class="keywordflow">break</span>;
<a name="l00381"></a>00381             }
<a name="l00382"></a>00382             lookAhead++;
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384         <span class="keywordflow">if</span> ( ! found )
<a name="l00385"></a>00385             spike++;
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="comment">// Sort by spike.value</span>
<a name="l00389"></a>00389     mergedSpikes.sort( <a class="code" href="struct_signature_1_1_spike.html#a0345ed985cbc94883286755c47ab0d63" title="Comparison function. Useful for sorting lists of spikes into descending order of absolute magnitude...">Spike::compareAbsValueDesc</a> );
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <span class="keywordflow">return</span> mergedSpikes;
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00405"></a><a class="code" href="class_signature.html#a6bf289b7aa40eb2791d13d8669089953">00405</a> <span class="keyword">const</span> list&lt;Signature::Spike&gt; <a class="code" href="class_signature.html#a6bf289b7aa40eb2791d13d8669089953" title="Merge consecutive spikes of the same sign and then remove any spikes under 10 Watts.">Signature::getMergedSpikes</a>()<span class="keyword"> const</span>
<a name="l00406"></a>00406 <span class="keyword"></span>{
<a name="l00407"></a>00407     <span class="comment">// LOCAL VARIABLES</span>
<a name="l00408"></a>00408     list&lt;Spike&gt; mergedSpikes;
<a name="l00409"></a>00409     <a class="code" href="struct_signature_1_1_spike.html" title="Recording the value and location of a Spike e.g. a Spike in the gradient of a signature.">Spike</a> spikeToStore;
<a name="l00410"></a>00410     <span class="keywordtype">double</span> currentDelta, lastDelta;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a602c8476861a638323bf9bf6a3d2176e" title="Length of spike in samples.">n</a> = spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a187d02dde42d87118b3913322fc545c6" title="Location to find this Spike.">index</a> = 0;
<a name="l00413"></a>00413     spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a0202c1bb6077ee752ef4e6a17839f6c0" title="Value of Spike at this location.">delta</a> = lastDelta = <a class="code" href="class_array.html#adeb6ee31eaa806644ce52552b8fc8bc1">getDelta</a>((<span class="keywordtype">size_t</span>)0);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=1; i&lt;(<a class="code" href="class_array.html#ab1dd0b3a06b008bf93de58d1194a554a" title="Number of members. size_t is 8bytes wide on x86_64.">size</a>-1); i++) {
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         currentDelta = <a class="code" href="class_array.html#adeb6ee31eaa806644ce52552b8fc8bc1">getDelta</a>(i);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <span class="comment">/* Check to see if this gradient is a continuation of</span>
<a name="l00420"></a>00420 <span class="comment">         * a larger spike.  i.e. does this gradient have the</span>
<a name="l00421"></a>00421 <span class="comment">         * same sign as the last gradient. */</span>
<a name="l00422"></a>00422         spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a602c8476861a638323bf9bf6a3d2176e" title="Length of spike in samples.">n</a>++;
<a name="l00423"></a>00423         <span class="keywordflow">if</span> ( ((lastDelta &gt; 0.0) &amp;&amp; (currentDelta &gt; 0.0)) || <span class="comment">// check both this and last spike have same sign and are non-zero</span>
<a name="l00424"></a>00424                 ((lastDelta &lt; 0.0) &amp;&amp; (currentDelta &lt; 0.0))    ) {
<a name="l00425"></a>00425             <span class="comment">// the current spike and the last spike are immediately</span>
<a name="l00426"></a>00426             <span class="comment">// adjacent, and both spikes are the same sign.  So these</span>
<a name="l00427"></a>00427             <span class="comment">// spikes need to be merged and not stored in mergedGradient yet.</span>
<a name="l00428"></a>00428             spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a0202c1bb6077ee752ef4e6a17839f6c0" title="Value of Spike at this location.">delta</a> += currentDelta;
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lastDelta == 0.0) &amp;&amp; (currentDelta != 0.0)) { <span class="comment">// are we starting a new spike after having been at zero?</span>
<a name="l00431"></a>00431             spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a187d02dde42d87118b3913322fc545c6" title="Location to find this Spike.">index</a> = i;
<a name="l00432"></a>00432             spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a602c8476861a638323bf9bf6a3d2176e" title="Length of spike in samples.">n</a> = 0;
<a name="l00433"></a>00433             spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a0202c1bb6077ee752ef4e6a17839f6c0" title="Value of Spike at this location.">delta</a> = currentDelta; <span class="comment">// reset mergedGradient</span>
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lastDelta == 0.0) &amp;&amp; (currentDelta == 0.0)) { <span class="comment">// we&#39;re in no man&#39;s land</span>
<a name="l00436"></a>00436             <span class="comment">// do nothing</span>
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438         <span class="keywordflow">else</span> {
<a name="l00439"></a>00439             <span class="comment">// store</span>
<a name="l00440"></a>00440             mergedSpikes.push_back( spikeToStore );
<a name="l00441"></a>00441 
<a name="l00442"></a>00442             <span class="comment">// reset</span>
<a name="l00443"></a>00443             spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a0202c1bb6077ee752ef4e6a17839f6c0" title="Value of Spike at this location.">delta</a> = currentDelta;
<a name="l00444"></a>00444             spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a602c8476861a638323bf9bf6a3d2176e" title="Length of spike in samples.">n</a> = 0;
<a name="l00445"></a>00445             spikeToStore.<a class="code" href="struct_signature_1_1_spike.html#a187d02dde42d87118b3913322fc545c6" title="Location to find this Spike.">index</a> = i;
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         lastDelta = currentDelta;
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="comment">/* remove any spikes under 10 Watts</span>
<a name="l00452"></a>00452 <span class="comment">     * (because these are very unlikely to be found in the</span>
<a name="l00453"></a>00453 <span class="comment">     * aggregate data)   */</span>
<a name="l00454"></a>00454     list&lt;Spike&gt;::iterator spike = mergedSpikes.begin();
<a name="l00455"></a>00455     <span class="keywordflow">while</span> (spike != mergedSpikes.end()) {
<a name="l00456"></a>00456         <span class="keywordflow">if</span> (fabs(spike-&gt;delta) &lt; 10)
<a name="l00457"></a>00457             mergedSpikes.erase( spike++ );
<a name="l00458"></a>00458         <span class="keywordflow">else</span>
<a name="l00459"></a>00459             spike++;
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <span class="keywordflow">return</span> mergedSpikes;
<a name="l00464"></a>00464 }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 
<a name="l00480"></a><a class="code" href="class_signature.html#a8af929317f348a75bc834499d355c49f">00480</a> <span class="keywordtype">void</span> <a class="code" href="class_signature.html#a8af929317f348a75bc834499d355c49f" title="Convert from the Signature data to a different sample period.">Signature::downSample</a>(
<a name="l00481"></a>00481         <a class="code" href="class_array.html">Array&lt;Sample_t&gt;</a> * output,
<a name="l00482"></a>00482         <span class="keyword">const</span> <span class="keywordtype">size_t</span> newPeriod,
<a name="l00483"></a>00483         <span class="keyword">const</span> <span class="keywordtype">bool</span> verbose
<a name="l00484"></a>00484         )<span class="keyword"> const</span>
<a name="l00485"></a>00485 <span class="keyword"></span>{
<a name="l00486"></a>00486     <span class="keywordtype">size_t</span> inner, inputIndex=0, outputIndex, outerLimit;
<a name="l00487"></a>00487     <a class="code" href="_common_8h.html#a735a41e7f307845b3589becd721cccaa" title="An individual sample (as recorded by a CurrentCost or WattsUp)">Sample_t</a> accumulator;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="keyword">const</span> <span class="keywordtype">size_t</span> newSize = (int)ceil(<a class="code" href="class_array.html#ab1dd0b3a06b008bf93de58d1194a554a" title="Number of members. size_t is 8bytes wide on x86_64.">size</a> / ( (<span class="keywordtype">double</span>)newPeriod / (<span class="keywordtype">double</span>)<a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a> ));
<a name="l00490"></a>00490     output-&gt;<a class="code" href="class_array.html#a5b752093b1b3ab4d82707115d1f41adc">setSize</a>( newSize );
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keyword">const</span> <span class="keywordtype">size_t</span> mod = newPeriod % <a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00494"></a>00494     <span class="keywordflow">if</span> (mod==0) {
<a name="l00495"></a>00495         <span class="comment">// newPeriod % samplePeriod == 0; so then just take an average of each step</span>
<a name="l00496"></a>00496         <span class="keyword">const</span> <span class="keywordtype">size_t</span> stepSize = newPeriod/<a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00497"></a>00497         <span class="keyword">const</span> <span class="keywordtype">size_t</span> delta = (newSize*newPeriod) - (<a class="code" href="class_array.html#ab1dd0b3a06b008bf93de58d1194a554a" title="Number of members. size_t is 8bytes wide on x86_64.">size</a>*samplePeriod);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499         <span class="keywordflow">if</span> (delta==0) {
<a name="l00500"></a>00500             outerLimit = newSize;
<a name="l00501"></a>00501         } <span class="keywordflow">else</span> {
<a name="l00502"></a>00502             outerLimit = newSize-1;
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <span class="keywordflow">if</span> (verbose) {
<a name="l00506"></a>00506             cout  &lt;&lt; <span class="stringliteral">&quot;old size=&quot;</span> &lt;&lt; <a class="code" href="class_array.html#ab1dd0b3a06b008bf93de58d1194a554a" title="Number of members. size_t is 8bytes wide on x86_64.">size</a> &lt;&lt; <span class="stringliteral">&quot;, old period=&quot;</span> &lt;&lt; samplePeriod
<a name="l00507"></a>00507                   &lt;&lt; <span class="stringliteral">&quot;, new size=&quot;</span> &lt;&lt; newSize &lt;&lt; <span class="stringliteral">&quot;, newPeriod=&quot;</span> &lt;&lt; newPeriod
<a name="l00508"></a>00508                   &lt;&lt; <span class="stringliteral">&quot;, stepSize=&quot;</span> &lt;&lt; stepSize &lt;&lt; <span class="stringliteral">&quot;, mod=&quot;</span> &lt;&lt; mod &lt;&lt; <span class="stringliteral">&quot;, delta=&quot;</span> &lt;&lt; delta &lt;&lt; <span class="stringliteral">&quot;,outerLimit=&quot;</span> &lt;&lt; outerLimit &lt;&lt; endl;
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         <span class="comment">// Do the vast majority of the resampling</span>
<a name="l00512"></a>00512         <span class="keywordflow">for</span> (outputIndex=0; outputIndex&lt;outerLimit; outputIndex++) {
<a name="l00513"></a>00513             accumulator=0;
<a name="l00514"></a>00514             <span class="keywordflow">for</span> (inner=0; inner&lt;stepSize; inner++) {
<a name="l00515"></a>00515                 inputIndex = inner+(outputIndex*stepSize);
<a name="l00516"></a>00516                 accumulator += <a class="code" href="class_array.html#a1ed7a8632e383152e0f03c5eecf7e917">data</a>[ inputIndex ];
<a name="l00517"></a>00517             }
<a name="l00518"></a>00518             (*output)[ outputIndex ] = accumulator/stepSize;
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521         <span class="comment">// Do the remainder (if there is any)</span>
<a name="l00522"></a>00522         <span class="keywordflow">if</span> (delta != 0) {
<a name="l00523"></a>00523             accumulator=0;
<a name="l00524"></a>00524             <span class="keywordtype">size_t</span> i;
<a name="l00525"></a>00525             <span class="keywordflow">for</span> (i=inputIndex; i&lt;<a class="code" href="class_array.html#ab1dd0b3a06b008bf93de58d1194a554a" title="Number of members. size_t is 8bytes wide on x86_64.">size</a>; i++) {
<a name="l00526"></a>00526                 accumulator += <a class="code" href="class_array.html#a1ed7a8632e383152e0f03c5eecf7e917">data</a>[i];
<a name="l00527"></a>00527             }
<a name="l00528"></a>00528             (*output)[ newSize-1 ] = accumulator/(delta-1);
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531     } <span class="keywordflow">else</span> {
<a name="l00532"></a>00532         <span class="comment">// newPeriod%samplePeriod!=0 so interpolate</span>
<a name="l00533"></a>00533         cerr &lt;&lt; <span class="stringliteral">&quot;resample() doesn&#39;t yet deal with fractional sample rate conversions&quot;</span> &lt;&lt; endl;
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a><a class="code" href="class_signature.html#a45f81ab2d31f0b640ce35164b1d56e5e">00537</a> <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_signature.html#a45f81ab2d31f0b640ce35164b1d56e5e">Signature::getSamplePeriod</a>()<span class="keyword"> const</span>
<a name="l00538"></a>00538 <span class="keyword"></span>{
<a name="l00539"></a>00539     <span class="keywordflow">return</span> <a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00545"></a><a class="code" href="class_signature.html#a8ab11925aa916b1d225dd72baba50a2c">00545</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="class_signature.html#a8ab11925aa916b1d225dd72baba50a2c" title="Determine how many Joules of energy have been consumed.">Signature::getEnergyConsumption</a>()<span class="keyword"> const</span>
<a name="l00546"></a>00546 <span class="keyword"></span>{
<a name="l00547"></a>00547     <span class="keywordtype">double</span> accumulator = 0;
<a name="l00548"></a>00548     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i=0; i&lt;<a class="code" href="class_array.html#ab1dd0b3a06b008bf93de58d1194a554a" title="Number of members. size_t is 8bytes wide on x86_64.">size</a>; i++) {
<a name="l00549"></a>00549         accumulator += <a class="code" href="class_array.html#a1ed7a8632e383152e0f03c5eecf7e917">data</a>[i];
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="keywordflow">return</span> accumulator * <a class="code" href="class_signature.html#a1219cd1698da6f0312fdacdb689940f6">samplePeriod</a>;
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a><a class="code" href="class_signature.html#a901e57da453530200cd9c177295a2cd3">00555</a> <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_signature.html#a901e57da453530200cd9c177295a2cd3">Signature::getID</a>()<span class="keyword"> const</span>
<a name="l00556"></a>00556 <span class="keyword"></span>{
<a name="l00557"></a>00557     <span class="keywordflow">return</span> <a class="code" href="class_signature.html#a33621ec2f18b6ec4e6d90f3b23bc8158" title="Each Device can have multiple signatures. A Device&amp;#39;s first sig gets a sigID of 0...">sigID</a>;
<a name="l00558"></a>00558 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_signature_8cpp.html">Signature.cpp</a>      </li>
      <li class="footer">Generated on Fri Sep 9 2011 17:06:35 for Disaggregate by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
